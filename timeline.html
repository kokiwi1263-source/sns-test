<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</title>
  <style>
    body { font-family: system-ui, -apple-system; background:#f5f5f5; margin:0; }
    header { background:#4f46e5; color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    main { max-width:820px; margin:16px auto; padding:0 12px; }
    .card { background:white; border-radius:12px; padding:12px; margin-bottom:12px; }
    textarea,input,select,button { width:100%; box-sizing:border-box; padding:10px; border-radius:10px; border:1px solid #ddd; margin-top:8px; }
    button { background:#4f46e5; color:white; border:none; font-weight:700; cursor:pointer; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .muted { color:#666; font-size:12px; }
    .post { border-top:1px solid #eee; padding-top:10px; margin-top:10px; }
    .badge { display:inline-block; background:#eef2ff; padding:2px 8px; border-radius:999px; font-size:12px; }
    .danger { background:#ef4444; }
    .small { width:auto; padding:6px 10px; font-size:12px; border-radius:999px; }
  </style>
</head>
<body>

<header>
  <div>
    <div style="font-weight:800;">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
    <div class="muted" id="userInfo"></div>
  </div>
  <button class="small danger" id="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</header>

<main>
  <div class="card">
    <div class="row">
      <input id="titleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
      <select id="cat">
        <option value="é€£çµ¡">é€£çµ¡</option>
        <option value="è³ªå•">è³ªå•</option>
        <option value="å…±æœ‰">å…±æœ‰</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
    </div>
    <textarea id="text" rows="4" placeholder="æœ¬æ–‡"></textarea>
    <button id="btn">æŠ•ç¨¿</button>
    <div id="msg" class="muted"></div>
  </div>

  <div class="card">
    <div class="row">
      <select id="filterCat">
        <option value="ALL">ã‚«ãƒ†ã‚´ãƒªï¼šã™ã¹ã¦</option>
        <option value="é€£çµ¡">é€£çµ¡</option>
        <option value="è³ªå•">è³ªå•</option>
        <option value="å…±æœ‰">å…±æœ‰</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <select id="scope">
        <option value="ALL">è¡¨ç¤ºï¼šå…¨å“¡</option>
        <option value="MINE">è¡¨ç¤ºï¼šè‡ªåˆ†ã ã‘</option>
      </select>
    </div>
    <input id="q" placeholder="æ¤œç´¢ï¼ˆåå‰/ã‚¿ã‚¤ãƒˆãƒ«/æœ¬æ–‡ï¼‰">
    <div class="muted" id="count"></div>
    <div id="list"></div>
  </div>
<div class="nav" style="position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:10px 0 calc(10px + env(safe-area-inset-bottom));">
  <button id="navHome" style="border:none;background:transparent;font-size:28px;cursor:pointer;">ğŸ </button>
  <button id="navRecipe" style="border:none;background:transparent;font-size:28px;cursor:pointer;">ğŸ²</button>
</div>

</main>

<script type="module">
document.getElementById("navHome").onclick = () => location.href = "./index.html";
document.getElementById("navRecipe").onclick = () => location.href = "./recipe.html";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot, doc, deleteDoc,
  runTransaction
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // ğŸ”‘ auth.html ã¨åŒã˜ firebaseConfig
  const firebaseConfig = {
    apiKey: "AIzaSyBsL9VrxyefbumHUKsQRfgoGQf2tJkYZtE",
    authDomain: "parent-beta-sns.firebaseapp.com",
    projectId: "parent-beta-sns",
    storageBucket: "parent-beta-sns.firebasestorage.app",
    messagingSenderId: "331616157000",
    appId: "1:331616157000:web:01e55e9d864e93028c077d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const me = JSON.parse(localStorage.getItem("sns_user"));
  if (!me?.uid) location.href = "./auth.html";

  const userInfo = document.getElementById("userInfo");
  const logoutBtn = document.getElementById("logout");
  const msg = document.getElementById("msg");
  const btn = document.getElementById("btn");
  const titleInput = document.getElementById("titleInput");
  const text = document.getElementById("text");
  const catSel = document.getElementById("cat");
  const filterCat = document.getElementById("filterCat");
  const scope = document.getElementById("scope");
  const qInput = document.getElementById("q");
  const count = document.getElementById("count");
  const list = document.getElementById("list");

  userInfo.textContent = `${me.name} ã•ã‚“ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;

  logoutBtn.onclick = () => {
    localStorage.removeItem("sns_user");
    location.href = "./auth.html";
  };

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );
  }

  const postsRef = collection(db, "posts");
  const qPosts = query(postsRef, orderBy("createdAt", "desc"));
  let latest = [];

  function match(p){
    if (scope.value === "MINE" && p.uid !== me.uid) return false;
    if (filterCat.value !== "ALL" && p.cat !== filterCat.value) return false;
    const kw = qInput.value.trim().toLowerCase();
    if (!kw) return true;
    const blob = (p.name+" "+(p.title||"")+" "+p.text).toLowerCase();
    return blob.includes(kw);
  }

  function render(){
    const shown = latest.filter(match);
    list.innerHTML = "";

    shown.forEach(p => {
if ((p.reportedBy || []).includes(me.uid)) return;

      // ğŸš« é€šå ±5ä»¶ä»¥ä¸Šã¯éè¡¨ç¤ºï¼ˆå®‰å…¨ç‰ˆï¼šä»Šã¯ãƒ€ãƒŸãƒ¼ã§0æ‰±ã„ï¼‰
const reportCount = p.reportCount || 0;
if (p.hidden || reportCount >= 5) {
  const d = document.createElement("div");
  d.className = "post muted";
  d.textContent = "ã“ã®æŠ•ç¨¿ã¯è¤‡æ•°ã®é€šå ±ã«ã‚ˆã‚Šéè¡¨ç¤ºã«ãªã£ã¦ã„ã¾ã™";
  list.appendChild(d);
  return;
}

      const mine = (p.uid === me.uid);
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `
        <div class="muted"><span class="badge">ã€${esc(p.cat)}ã€‘</span> ${esc(p.name)} ã•ã‚“</div>
        <div style="font-weight:800;margin-top:6px;">${esc(p.title || "ï¼ˆç„¡é¡Œï¼‰")}</div>
        <div style="margin-top:6px;">${esc(p.text)}</div>
        <div class="muted" style="margin-top:6px;">${esc(p.timeText || "")}</div>
        ${mine ? `<button class="small danger" data-del="${esc(p.id)}">å‰Šé™¤</button>` : ``}
        <button class="small" data-report="${esc(p.id)}">é€šå ±</button>
      `;
      list.appendChild(div);
    });

    count.textContent = `è¡¨ç¤ºï¼š${shown.length} ä»¶ / å…¨ä½“ï¼š${latest.length} ä»¶`;
  }

  onSnapshot(qPosts, (snap) => {
    latest = snap.docs.map(d => {
      const data = d.data();
      return {
        id: d.id,
        ...data,
        timeText: data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : ""
      };
    });
    render();
  });

  // âœï¸ æŠ•ç¨¿
  btn.onclick = async () => {
    const body = text.value.trim();
    if (!body) { msg.textContent = "æœ¬æ–‡ã‚’å…¥ã‚Œã¦ã­"; return; }

await addDoc(postsRef, {
  uid: me.uid,
  name: me.name,
  title: titleInput.value.trim(),
  text: body,
  cat: catSel.value,
  createdAt: serverTimestamp(),
  reportCount: 0,
  reportedBy: [],
  hidden: false
});

    titleInput.value = "";
    text.value = "";
    msg.textContent = "æŠ•ç¨¿ã—ã¾ã—ãŸï¼";
  };

  // ğŸ—‘ï¸ å‰Šé™¤
list.addEventListener("click", async (e) => {

  // é€šå ±
  const r = e.target.closest("button[data-report]");
if (r) {
  const postId = r.getAttribute("data-report");
  const reason = (prompt("é€šå ±ç†ç”±ï¼ˆä»»æ„ï¼‰") || "").trim();

  // posts ã® reportedBy ã«ã€Œè‡ªåˆ†ã®uidã€ã‚’è¿½åŠ ï¼ˆé‡è¤‡ã¯å¼¾ãï¼‰
  await runTransaction(db, async (tx) => {
    const ref = doc(db, "posts", postId);
    const snap = await tx.get(ref);
    const data = snap.data() || {};

    const reportedBy = data.reportedBy || [];
    if (reportedBy.includes(me.uid)) {
      alert("ã“ã®æŠ•ç¨¿ã¯ã™ã§ã«é€šå ±ã—ã¦ã„ã¾ã™");
      return;
    }

    const nextReportedBy = [...reportedBy, me.uid];
    const nextCount = nextReportedBy.length;

    tx.update(ref, {
      reportedBy: nextReportedBy,
      reportCount: nextCount,
      hidden: nextCount >= 5
    });
  });

  // reports ã«ã‚‚è¨˜éŒ²ï¼ˆè¨¼è·¡ï¼‰
  await addDoc(collection(db, "reports"), {
    postId,
    reason,
    reporterUid: me.uid,
    reporterName: me.name,
    createdAt: serverTimestamp()
  });

  alert("é€šå ±ã—ã¾ã—ãŸï¼ˆã“ã®æŠ•ç¨¿ã¯ã‚ãªãŸã®ç”»é¢ã‹ã‚‰éè¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼‰");
  return;
}

  // å‰Šé™¤ï¼ˆæ—¢å­˜ï¼‰
  const b = e.target.closest("button[data-del]");
  if (!b) return;
  const id = b.getAttribute("data-del");
  const p = latest.find(x => x.id === id);
  if (!p || p.uid !== me.uid) return;
  if (!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await deleteDoc(doc(db, "posts", id));
});

  filterCat.onchange = render;
  scope.onchange = render;
  qInput.oninput = render;

  onAuthStateChanged(auth, (user) => {
    if (!user) location.href = "./auth.html";
  });
</script>
</body>
</html>

